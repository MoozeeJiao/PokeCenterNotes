# Redis中使用bitmap内存突增问题探究

# 背景

公司某日起连续3天，Redis内存大幅增加。并且增幅逐渐减小。机器上使用了上亿个 bitmap，每个 bitmap 位数长度从几十到几千不等，且每天都会增加。

# 理论分析

观察应用的行为记录发现，redis 内存大幅增加都是发生在 bitmap 位数增长之后。按道理来说每次只有大约 1千万的 bitmap 增加 1 位，最多增长10M（分布到 40 个节点的集群上，每个节点 250K）为什么会发生内存的突增呢？

查阅redis 原理发现，bitmap 底层的数据结构是简单动态字符串 sds [[01_Redis String 实现]]

为避免每次字符串append操作都需要重新分配内存，每当已分配内容不够用时，malloc 会申请全新内存使原有内存翻倍（或增加1m）。因为 bitmap 太多了，导致内存突增。

# 实验验证

使用程序不断增加一个 bitmap 的长度，观察 redis 使用内存的变化，结果如下图：

![[redis_memory.png]]

我们得到以下结论：

1. bitmap 初始化时，sds 申请内存 3+1+1=4B（header+数据+'\\0'），而默认的[[02_Redis 内存分配|内存管理系统]] jemalloc 会为其分配 8B 的空间，这样除去 header 和截止符有 4B 的空间留给数据存放。因此可以看到 bitmap 增长的前 31位（31>>3+1=4）都没有发生内存的变化，直到第 32位（32>>3+1=5）才需要申请新的内存；
2. 随着 bitmap (sds) 的增长，redis 为其分配的内存是倍增式的。倍增的公式是 (数据长度+新增长度)\*2 (小于1M时)，如第 32位时，(4+1)\*2=10。加上  header 和截止符需要申请 3+10+1=14B 的空间，jemalloc 会分配 16B，这样数据空间就会有 12B，bitmap 能存到 95位。
