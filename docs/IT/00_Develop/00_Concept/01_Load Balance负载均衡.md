# 负载均衡 Load Balance

>http://icyfenix.cn/architect-perspective/general-architecture/diversion-system/load-balancing.html

调度后方多台机器，暴露统一的接口提供服务，此类组件称为负载均衡器。

## DNS 负载均衡

域名 -> CNAME -> 负载调度服务 -> 就近的数据中心入口

根据用户的IP地址等信息，分配一个数据中心提供服务。

后续内容为网络请求进入数据中心后的负载均衡。

## 总论

一般按照OSI模型将负载均衡分为7层（应用层）和4层（传输层）两种

* 4层的特点是性能强，7层的特点是功能多；
* 做多级负载均衡，需低层在前高层在后。

4层的意思是说工作模式是维持同一个tcp连接，实际上这些方法工作在2层（链路层改写MAC地址）或3层（网络层改写IP地址）

## 数据链路层负载均衡

数据链路层传输的是数据帧，其中包括“源目标MAC地址”和“目标MAC地址”，这个两个地址告诉交换机，数据帧是从哪个网卡发到哪个网卡去。

链路层负载均衡就是将请求中数据帧的目标MAC地址从负载均衡器的改为真实服务器的。上层的协议并没有改变，所以第3层看来这个数据包还是从客户端IP到负载均衡器IP，这就需要使用*虚拟IP*技术将负载均衡器和真实服务器配置相同的IP。真实服务器就可以顺利处理请求并直接将结果传回给客户端，避免负载均衡器的网卡带宽成为瓶颈。

![[lay2lb.png]]

这个模式争个请求、转发、响应形成一个三角关系，因此称为三角传输模式或直接路由。

数据链路层的效率很高，但是并不适用于所有场合，需要感知应用层协议的场合无法使用外，负载均衡器与真实服务器的通信必须是2层可达的，即在同一个子网。无法跨VLAN。

## 网络层负载均衡

网络层传输的是分组数据包，其中header包含源和目标的IP地址，代表了数据包是从哪台机器发送到哪台机器的。可以修改目标IP地址实现数据包的转发。

### IP隧道模式

保持原数据包不变，新创建一个数据包，将原包作为他的playLoad。新包的header中源IP为负载均衡器，目标IP为真实服务器。真实服务器接收到数据包后，必须在接口处设计一个针对性的拆包，拿出原数据包进行使用。真实服务器可以直接对客户端进行应答（虚拟IP）。

![[lay3iplb1.png]]


由于IP隧道工作在网络层，所以可以*跨VLAN*。

IP隧道的方法要求真实服务器必须支持IP隧道协议，和VIP。尤其是虚拟IP，在好几个服务在同一台物理机上时就不行了。

### NAT模式

直接将原包的header的目标IP为真实服务器的新header。这样客户端就无法认识真实服务器，真实服务器就无法直接响应了。

![[lay3iplb.png]]

这种模式与NAT的工作原理类似，因此称为NAT模式。会给性能带来较大损失，整个系统的瓶颈容易在负载均衡器上。

还有一种更彻底的直接将原包的源地址也改为负载均衡器的，称为SNAT，这样真实服务器无需配置网关就能响应回负载均衡器了，缺点是拿不到客户端IP，有一些业务逻辑可能就做不了了。

## 应用层负载

4层负载均衡都属于转发，客户端到真实服务器都维持着同一条tcp通道。4层之上就无法进行转发了，只能进行代理，客户端、负载均衡、服务器之间维持着2条tcp通道。

![[lay7lb.png]]

代理根据对哪一方透明的原则可以分为：

* 正向代理：对服务器透明；
* 反向代理：对客户端透明；
* 透明代理：对两边透明，通常架设在网络中间设备上。

7层负载均衡属于反向代理，他比4层多一次tcp握手，跟NAT模式一样有带宽问题，通常更耗费CPU。其突出特点是工作在应用层可以有更多规则。比如可以缓存一些CDN静态资源，命中直接返回，配置一些基于session的安全策略，进行熔断降级等链路治理。

## 均衡策略

-   轮循均衡（Round Robin）
-   权重轮循均衡（Weighted Round Robin）
-   随机均衡（Random
-   权重随机均衡（Weighted Random）
-   一致性哈希均衡（Consistency Hash）
-   响应速度均衡（Response Time）
-   最少连接数均衡（Least Connection）

## 分类

* 软件负载均衡
	* 内核均衡器：LVS
	* 应用均衡器：Nginx、HAProxy
* 硬件负载均衡：F5、A10

