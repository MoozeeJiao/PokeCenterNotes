# 数据库系统内幕

## 一、简介与概述

* OLTP: 大量短请求
* OLAP: 复杂长时间的聚合查询
* HTAP: 混合

### 1. 数据库架构

![[Drawing 2023-11-12 15.53.45.excalidraw.svg]]

### 2. 内存数据库与磁盘数据库

*内存数据库*：数据主要在内存，用磁盘管理日志和故障恢复。

* 优点：快；系统抽象了内存管理
* 缺点：易失（NVM）

使用硬盘持久化：

1. 预写日志：故障后重放
2. 备份副本：批处理，内存快照，checkpointing，之前的日志可以丢弃

*硬盘数据库*：用内存缓存内容或临时
* 优点：大
* 缺点：手动管理索引、序列化、空间；指针随机访问慢（宽树、矮树）

*空间局部性：访问一个数据，他附近的也会马上访问*

### 3. 面向行、面向列

* 行：MySql，PostgreSql
	* 提高空间局部性
* 列：MontDB，C-store
	* 列值用隐式ID（偏移量）来映射到主键
	* 不同列类型不同压缩方法
	* 向量指令处理多个数据点
* 宽列：HBase
	* 多维映射，键检索
	* 每个列族中行存

### 4. 数据文件和索引文件

*数据文件*：通常一个表一个，有分页（槽）的概念；考虑存储效率、访问效率、更新效率。

不显示删除，在标记后回收。

| 实现 | 特点 |
| -- | -- |
| 索引组织表 | 数据记录在索引自身；磁盘查找次数可以减少至1此 |
| 堆组织表 | 没有特定顺序，按写入顺序放；需额外索引指向数据 |
| 哈希组织表 | 分桶；可以桶中有序，键有序 |

*索引文件*：高校检索数据

* 主索引：主键
* 二级索引：其他
	* 可以指向数据或主索引
* 聚簇索引：数据遵循索引顺序，放在一个文件中

### 5. 缓冲、不可变、有序性

在些方向上优化产生不同DB

*缓冲*：放入磁盘前是否在内存中放一段时间；

*可变性*：在文件同一位置读到某些部分，更新并写入文件；（不可变：只追加改）

*有序性*：数据是否按键顺序存储 / 写入顺序


